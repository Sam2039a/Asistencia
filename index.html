<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asistencia MiShalom</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --azul-marino: #0b1d3a;
      --celeste: #00d6c2;
      --celeste-oscuro: #00988a;
      --fondo-oscuro: #1e1e1e;
      --texto-claro: #f0f0f0;
      --verde-vivo: #32cd32;
      --rosa: #ff69b4;
      --azul-hombre: #1a76c2;
      --rojo-nino: #e74c3c;
      --amarillo-tercera: #f1c40f;
      --header-bg: #031424;
      --nav-bg: var(--celeste);
      --nav-active-bg: var(--celeste);
      --nav-inactive-bg: var(--celeste-oscuro);
      --nav-active-color: #000000;
    }

    body {
      margin: 0; padding: 0;
      background-color: var(--fondo-oscuro);
      color: var(--texto-claro);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    header {
      background-color: var(--header-bg);
      padding: 15px;
      text-align: center;
      border-bottom: 2px solid var(--celeste);
    }

    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 900;
      color: var(--celeste);
    }

    nav {
      display: flex;
      background-color: var(--nav-bg);
      border-bottom: 2px solid var(--celeste);
    }

    nav button {
      flex: 1;
      padding: 18px 0;
      background-color: var(--nav-inactive-bg);
      border: none;
      color: var(--nav-active-color);
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
      box-shadow: none;
    }

    nav button.active {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-color);
      box-shadow: 0 0 15px 3px rgba(0, 214, 194, 0.7);
    }

    nav button:hover:not(.active) {
      background-color: var(--celeste);
    }

    .container {
      max-width: 480px;
      margin: 25px auto;
      padding: 0 15px 40px;
    }

    .counter {
      background: #2f2f2f;
      margin-bottom: 15px;
      padding: 14px 20px;
      border-radius: 12px;
      text-align: center;
    }

    .counter div {
      font-size: 20px;
      font-weight: 600;
    }

    .controls {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      gap: 14px;
    }

    .controls button {
      background-color: var(--celeste);
      color: black;
      border: none;
      font-size: 20px;
      font-weight: 700;
      padding: 8px 22px;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      user-select: none;
    }

    .controls button:hover {
      background-color: #00a899;
    }

    .total-highlight {
      background-color: var(--celeste);
      color: black;
      font-weight: 900;
      font-size: 24px;
      text-align: center;
      border-radius: 12px;
      padding: 14px 0;
      margin: 25px 0 10px;
    }

    .category-summary {
      font-size: 16px;
      line-height: 1.4;
      margin-bottom: 20px;
    }

    .category-summary div {
      margin: 5px 0;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .enviar-btn {
      background-color: var(--azul-marino);
      color: var(--texto-claro);
      font-weight: 700;
      border-radius: 12px;
      padding: 14px 32px;
      border: none;
      font-size: 20px;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      display: block;
      margin: 25px auto 0;
      width: 60%;
      max-width: 280px;
      text-align: center;
      box-shadow: 0 0 16px 4px #00d6c280, 0 0 1px #fff;
    }

    .enviar-btn:hover {
      background-color: #051423;
      box-shadow: 0 0 24px 8px #00fff680, 0 0 1px #fff;
    }

    .guardar-btn, .reiniciar-btn {
      font-weight: 700;
      border-radius: 12px;
      padding: 14px 32px;
      border: none;
      font-size: 20px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      flex: none;
      min-width: 140px;
      text-align: center;
    }

    .guardar-btn {
      background-color: var(--verde-vivo);
      color: black;
    }

    .guardar-btn:hover {
      background-color: #28b428;
    }

    .reiniciar-btn {
      background-color: #e74c3c;
      color: white;
    }

    .reiniciar-btn:hover {
      background-color: #c0392b;
    }

    .chart-container {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }

    canvas {
      background-color: transparent !important;
      width: 100% !important;
      height: auto !important;
      aspect-ratio: 1 / 1;
    }

    #titulo-captura {
      font-size: 24px;
      font-weight: bold;
      color: #00d6c2;
      text-align: center;
      margin-bottom: 10px;
    }

    #capture-area {
      background: var(--fondo-oscuro) !important;
      color: var(--texto-claro);
      padding: 15px;
      border-radius: 18px;
    }

    #subnombre-captura {
      font-size: 20px;
      font-weight: 600;
      color: #fff;
      text-align: center;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
      font-style: italic;
      text-shadow: 0 1px 6px #00d6c299, 0 0 1px #fff;
    }

    /* Nuevos estilos para Adultos y Niños global */
    .global-extra-totals {
      background: #222;
      color: #fff;
      font-size: 20px;
      font-weight: 800;
      text-align: center;
      border-radius: 12px;
      padding: 10px 0;
      margin-bottom: 10px;
      margin-top: 5px;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .global-extra-totals span {
      color: #00d6c2;
      font-size: 22px;
      font-weight: 900;
      margin: 0 8px;
    }
  </style>
</head>
<body>

<header>
  <h1>Asistencia MiShalom</h1>
</header>

<nav>
  <button id="tab-individual" class="active" onclick="switchTab('individual')">Conteo Individual</button>
  <button id="tab-global" onclick="switchTab('global')">Conteo Global</button>
</nav>

<!-- Interfaz Conteo Individual -->
<div id="individual" class="container">
  <p id="fecha-individual"></p>

  <div class="counter" id="mujeres">
    <div>Mujeres: <span class="count">0</span></div>
    <div class="controls">
      <button onclick="updateCount('mujeres', -1)">-</button>
      <button onclick="updateCount('mujeres', 1)">+</button>
    </div>
  </div>

  <div class="counter" id="hombres">
    <div>Hombres: <span class="count">0</span></div>
    <div class="controls">
      <button onclick="updateCount('hombres', -1)">-</button>
      <button onclick="updateCount('hombres', 1)">+</button>
    </div>
  </div>

  <div class="counter" id="ninos">
    <div>Niños: <span class="count">0</span></div>
    <div class="controls">
      <button onclick="updateCount('ninos', -1)">-</button>
      <button onclick="updateCount('ninos', 1)">+</button>
    </div>
  </div>

  <div class="counter" id="tercera">
    <div>Tercera Edad: <span class="count">0</span></div>
    <div class="controls">
      <button onclick="updateCount('tercera', -1)">-</button>
      <button onclick="updateCount('tercera', 1)">+</button>
    </div>
  </div>

  <div class="total-highlight">Total: <span id="total">0</span></div>
  <div class="chart-container">
    <canvas id="chart-individual"></canvas>
  </div>

  <button class="enviar-btn" onclick="guardarConteo()">Enviar</button>
</div>

<!-- Interfaz Conteo Global -->
<div id="global" class="container" style="display:none;">
  <div id="capture-area">
    <div id="titulo-captura">Asistencia MiShalom</div>
    <div id="subnombre-captura"></div>
    <p id="fecha-global"></p>
    <div class="category-summary" id="resumen-global"></div>
    <!-- Adultos y Niños global -->
    <div class="global-extra-totals">
      Adultos: <span id="total-adultos-global">0</span>
      Niños: <span id="total-ninos-global">0</span>
    </div>
    <div class="total-highlight">Total: <span id="total-global">0</span></div>
    <div class="chart-container">
      <canvas id="chart-global"></canvas>
    </div>
  </div>

  <div class="button-group" id="botones-captura">
    <button class="guardar-btn" onclick="descargarImagen()">Guardar imagen</button>
    <button class="reiniciar-btn" onclick="reiniciarConteo()">Reiniciar Conteo</button>
  </div>
</div>

<script>
  // --- Configuración Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyB35zZ1kjLkTRhK4qAQblIZnrAPUEk-ur0",
    authDomain: "mishalom-bf920.firebaseapp.com",
    databaseURL: "https://mishalom-bf920-default-rtdb.firebaseio.com",
    projectId: "mishalom-bf920",
    storageBucket: "mishalom-bf920.appspot.com",
    messagingSenderId: "757932942282",
    appId: "1:757932942282:web:c78e00f455b58c60922533",
    measurementId: "G-EL431318HR"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let userId = localStorage.getItem('userId');
  if (!userId) {
    userId = 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('userId', userId);
  }

  const counts = {
    mujeres: 0,
    hombres: 0,
    ninos: 0,
    tercera: 0
  };

  function formatearFechaExtendida(fecha = new Date()) {
    const dias = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
    const meses = [
      'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
      'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
    ];
    const diaSemana = dias[fecha.getDay()];
    const dia = fecha.getDate();
    const mes = meses[fecha.getMonth()];
    const anio = fecha.getFullYear();
    return `${diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1)}, ${dia} de ${mes} ${anio}`;
  }

  const fechaObj = new Date();
  document.getElementById("fecha-individual").textContent = "Fecha: " + formatearFechaExtendida(fechaObj);
  document.getElementById("fecha-global").textContent = "Fecha: " + formatearFechaExtendida(fechaObj);

  const colores = {
    mujeres: '#ff69b4',
    hombres: '#1a76c2',
    ninos: '#e74c3c',
    tercera: '#f1c40f'
  };

  let ultimoNombreUsuario = localStorage.getItem('nombreUsuario') || "";

  function crearConfigGrafico(data) {
    return {
      type: 'doughnut',
      data: {
        labels: ['Mujeres', 'Hombres', 'Niños', 'Tercera Edad'],
        datasets: [{
          data: [data.mujeres, data.hombres, data.ninos, data.tercera],
          backgroundColor: [
            colores.mujeres,
            colores.hombres,
            colores.ninos,
            colores.tercera
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#ccc' }
          }
        }
      }
    };
  }

  const ctxIndividual = document.getElementById('chart-individual').getContext('2d');
  const ctxGlobal = document.getElementById('chart-global').getContext('2d');

  let chartIndividual = new Chart(ctxIndividual, crearConfigGrafico(counts));
  let chartGlobal = new Chart(ctxGlobal, crearConfigGrafico({mujeres:0,hombres:0,ninos:0,tercera:0}));

  function updateCount(category, delta) {
    const newValue = counts[category] + delta;
    if (newValue < 0) return;
    counts[category] = newValue;
    document.querySelector(`#${category} .count`).textContent = newValue;
    let total = counts.mujeres + counts.hombres + counts.ninos + counts.tercera;
    document.getElementById('total').textContent = total;
    chartIndividual.data.datasets[0].data = [counts.mujeres, counts.hombres, counts.ninos, counts.tercera];
    chartIndividual.update();
  }

  function switchTab(tab) {
    if (tab === 'individual') {
      document.getElementById('individual').style.display = 'block';
      document.getElementById('global').style.display = 'none';
      document.getElementById('tab-individual').classList.add('active');
      document.getElementById('tab-global').classList.remove('active');
    } else {
      document.getElementById('individual').style.display = 'none';
      document.getElementById('global').style.display = 'block';
      document.getElementById('tab-global').classList.add('active');
      document.getElementById('tab-individual').classList.remove('active');
      cargarConteoGlobal();
      if (!window._autoGlobalUpdater) {
        window._autoGlobalUpdater = setInterval(cargarConteoGlobal, 10000);
      }
    }
  }

  // MODIFICADO: guardar múltiples respuestas por usuario en vez de sobrescribir
  function guardarConteo() {
    const total = counts.mujeres + counts.hombres + counts.ninos + counts.tercera;
    if (total === 0) {
      alert('Por favor, ingrese al menos una persona antes de enviar.');
      return;
    }
    const fechaKey = new Date().toISOString().slice(0,10);
    // Creamos un nuevo "push" para cada respuesta del usuario
    const userPushRef = database.ref(`conteos/${fechaKey}/${userId}`).push();

    userPushRef.set({
      mujeres: counts.mujeres,
      hombres: counts.hombres,
      ninos: counts.ninos,
      tercera: counts.tercera,
      timestamp: Date.now()
      // No se guarda nombre aquí
    })
      .then(() => {
        alert('Conteo enviado exitosamente.');
        reiniciarIndividual();
        database.ref(`conteos/${fechaKey}/_lastUpdate`).set(Date.now());
      })
      .catch((error) => {
        alert('Error al enviar conteo: ' + error.message);
      });
  }

  function mostrarSubtituloGlobal(nombre) {
    const subtituloDiv = document.getElementById('subnombre-captura');
    if (nombre) {
      subtituloDiv.textContent = nombre;
      subtituloDiv.style.display = '';
    } else {
      subtituloDiv.textContent = '';
      subtituloDiv.style.display = 'none';
    }
  }

  function reiniciarIndividual() {
    for (let cat in counts) {
      counts[cat] = 0;
      document.querySelector(`#${cat} .count`).textContent = 0;
    }
    document.getElementById('total').textContent = 0;
    chartIndividual.data.datasets[0].data = [0,0,0,0];
    chartIndividual.update();
  }

  function cargarConteoGlobal() {
    const fechaKey = new Date().toISOString().slice(0,10);
    const conteosRef = database.ref(`conteos/${fechaKey}`);

    conteosRef.once('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        actualizarResumenGlobal({mujeres:0,hombres:0,ninos:0,tercera:0});
        mostrarSubtituloGlobal("");
        return;
      }
      let totalGlobal = {mujeres:0,hombres:0,ninos:0,tercera:0};
      for (const user in data) {
        if (user === '_lastUpdate') continue;
        const userEntries = data[user];
        // Si userEntries es un objeto, revisar si es un push de múltiples entradas
        if (userEntries && typeof userEntries === 'object' && !Array.isArray(userEntries)) {
          for (const entryKey in userEntries) {
            const conteo = userEntries[entryKey];
            // Verificar que contiene los campos esperados
            if (conteo && typeof conteo === 'object' && 'mujeres' in conteo && 'hombres' in conteo && 'ninos' in conteo && 'tercera' in conteo) {
              totalGlobal.mujeres += conteo.mujeres || 0;
              totalGlobal.hombres += conteo.hombres || 0;
              totalGlobal.ninos += conteo.ninos || 0;
              totalGlobal.tercera += conteo.tercera || 0;
            }
          }
        }
      }
      actualizarResumenGlobal(totalGlobal);
      mostrarSubtituloGlobal(""); // No mostrar nombre por defecto
    });
  }

  function actualizarResumenGlobal(totalGlobal) {
    const total = totalGlobal.mujeres + totalGlobal.hombres + totalGlobal.ninos + totalGlobal.tercera;
    const adultos = totalGlobal.mujeres + totalGlobal.hombres + totalGlobal.tercera;
    const ninos = totalGlobal.ninos;
    const resumenDiv = document.getElementById('resumen-global');
    function porcentaje(valor, total) {
      if (total === 0) return "0%";
      let val = (valor * 100 / total);
      if (val === 0) return "0%";
      if (Math.floor(val) === val) return `${val}%`;
      let str = val.toFixed(1);
      if (str.endsWith('.0')) str = str.slice(0, -2);
      return `${str}%`;
    }
    resumenDiv.innerHTML = `
      <div style="color:${colores.mujeres}; font-weight: 700;">
        Mujeres: ${totalGlobal.mujeres} (${porcentaje(totalGlobal.mujeres, total)})
      </div>
      <div style="color:${colores.hombres}; font-weight: 700;">
        Hombres: ${totalGlobal.hombres} (${porcentaje(totalGlobal.hombres, total)})
      </div>
      <div style="color:${colores.ninos}; font-weight: 700;">
        Niños: ${totalGlobal.ninos} (${porcentaje(totalGlobal.ninos, total)})
      </div>
      <div style="color:${colores.tercera}; font-weight: 700;">
        Tercera Edad: ${totalGlobal.tercera} (${porcentaje(totalGlobal.tercera, total)})
      </div>
    `;
    // NUEVO: actualizar Adultos y Niños global
    document.getElementById('total-adultos-global').textContent = adultos;
    document.getElementById('total-ninos-global').textContent = ninos;
    // Total General
    document.getElementById('total-global').textContent = total;
    chartGlobal.data.datasets[0].data = [
      totalGlobal.mujeres,
      totalGlobal.hombres,
      totalGlobal.ninos,
      totalGlobal.tercera
    ];
    chartGlobal.update();
  }

  function descargarImagen() {
    let nombre = prompt('Por favor, ingresa el nombre que debe aparecer en la imagen:', ultimoNombreUsuario);
    if (!nombre) {
      alert('No se descargó la imagen. Es necesario ingresar un nombre.');
      return;
    }
    nombre = nombre.trim();
    if (!nombre) {
      alert('No se descargó la imagen. Es necesario ingresar un nombre.');
      return;
    }
    localStorage.setItem('nombreUsuario', nombre);
    ultimoNombreUsuario = nombre;
    mostrarSubtituloGlobal(nombre);

    const area = document.getElementById('capture-area');
    const originalBg = area.style.backgroundColor;
    area.style.backgroundColor = '#1e1e1e';
    html2canvas(area, {
      backgroundColor: '#1e1e1e'
    }).then(canvas => {
      const link = document.createElement('a');
      link.download = `asistencia_mishalom_${new Date().toISOString().slice(0,10)}.png`;
      link.href = canvas.toDataURL();
      link.click();
      area.style.backgroundColor = originalBg;
      mostrarSubtituloGlobal(""); // quitar el nombre después de capturar
    });
  }

  function reiniciarConteo() {
    const pass = prompt('Ingrese la contraseña para reiniciar el conteo:');
    if (pass !== '2039') {
      alert('Contraseña incorrecta. No se realizó el reinicio.');
      return;
    }
    if (!confirm('¿Seguro que desea reiniciar todo el conteo global? Se eliminarán todos los datos del día.')) return;
    const fechaKey = new Date().toISOString().slice(0,10);
    const conteosRef = database.ref(`conteos/${fechaKey}`);
    conteosRef.remove()
      .then(() => {
        actualizarResumenGlobal({mujeres:0,hombres:0,ninos:0,tercera:0});
        mostrarSubtituloGlobal("");
        alert('Conteo global reiniciado.');
      })
      .catch((error) => {
        alert('Error al reiniciar conteo: ' + error.message);
      });
  }

  (function activarActualizacionGlobal() {
    const fechaKey = new Date().toISOString().slice(0,10);
    const conteosRef = database.ref(`conteos/${fechaKey}`);
    conteosRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        actualizarResumenGlobal({mujeres:0,hombres:0,ninos:0,tercera:0});
        mostrarSubtituloGlobal("");
        return;
      }
      let totalGlobal = {mujeres:0,hombres:0,ninos:0,tercera:0};
      for (const user in data) {
        if (user === '_lastUpdate') continue;
        const userEntries = data[user];
        if (userEntries && typeof userEntries === 'object' && !Array.isArray(userEntries)) {
          for (const entryKey in userEntries) {
            const conteo = userEntries[entryKey];
            if (conteo && typeof conteo === 'object' && 'mujeres' in conteo && 'hombres' in conteo && 'ninos' in conteo && 'tercera' in conteo) {
              totalGlobal.mujeres += conteo.mujeres || 0;
              totalGlobal.hombres += conteo.hombres || 0;
              totalGlobal.ninos += conteo.ninos || 0;
              totalGlobal.tercera += conteo.tercera || 0;
            }
          }
        }
      }
      actualizarResumenGlobal(totalGlobal);
      mostrarSubtituloGlobal(""); // No mostrar nombre por defecto
    });
  })();

</script>
</body>
</html>
